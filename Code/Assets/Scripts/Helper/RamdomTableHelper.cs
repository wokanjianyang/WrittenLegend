using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using UnityEngine;
using Random = System.Random;

namespace Game
{
    public class RandomRecord
    {
        public int x { get; set; } = 0;
        public int y { get; set; } = 0;

        public int v { get; set; } = 0;

        public void Next()
        {
            y++;
            if (y >= 100)
            {
                y = 0;
                x++;
                if (x >= 100)
                {
                    x = 0;
                }
            }
        }
    }

    public class RandomTableHelper
    {
        private const string TableText = "6881151665213756855745948465091070213476209102345420131728595844001838111067333896498166182926635190076241451999299837738606552990179298988448739057138446105434087662493895060045998002648300536464694489442876394080635242107633595040912618148864823111154547222428706274351389522578135309232685276548374976697636450904701148710741101494972267229650025003199017251268491374412633302021119762577202596008192553112248237665677193389195028939621425213083929631485289663249904815216610946496816768278750862627458538105882515677740729467968383903604681464228087121055944089058057028509033656988878642572698637731210145111482222924808159563619834634086753136041054624718169976767499583656721610466601470034821802091345818409350756341397207866357501183970992381557937378896341262129595792080155010909973028510434405895518938459047328855009684163984205414367219493891895914621201940203496429592703514029698409803102000098470888336539377424998317299724433959459877947602784646515029572317281504063926115417009676463183684022908621939589226380886770935470137651496137122522195887546612993123474751483992758747435641767836506953029191395140638516174614902653748985716551955233689457642407497386392268918236655599100907429584556565992154778766110565378821383040416220200122641351635914376431803169445617379872654602671185584577937865764507912210829848175551652814287749888177438620567321865682091551840300126537327750068740479641850492782616031828056521216534561803043447624772290544601535758449390687684033218419673466166685717688979883375495531408042915694681831140624280781505466396659181328712607618529875795177665115937014253866349375773595386571155017248086153783423584769503557407822956438701923813251432514681804542189457942474339683016584046748540804284220433055123916558179930265910510379409012236174665027389611483648019066433285430798096803459324713666349859105974747404910597342656225578629682605654812005420826194467071786689832929459576428198271290290512768972424538780565936932812076210867796086492662196264709455088432468503352684814695302416123852468502938111885562429814698258290802084351782141065728325289410608576974899375927896192387048597602093491877344849325286623785439610049204397889015554166876315200445255025244858823511253183532903613295355492872216784851491425152086762547943464739404427103976511113637520501471103801769552262966069329649571088193099937235841072681117905543692909453183082150741592696562728542373719773921704321998219072160229711715835682230903995789932425735833515153894122017254571488780235280633073032391621409478394355549023617606033041342753420542277880039754064122532893698204021890619353484815762096115182438308433515734274336980445216827221429282040508089195591586138954509297818357139573617420198151180897168694217292032651938161381011287404249778600334657427750781319685982681860229496643899286791080770151783650144700361541135384997523610638829853460909700437596057536674766412516407963891359942193872265823730331918407181599356248664581738816732388516410610090670696857805033071770357111740852525825467007615903510200684339601358525213892524423311488281535476554596339182898784294279380171290449404664026165380352987257883227286463397315738830827255033392493619669923547029222226044731019094096348675308451806198300804488373286850663127296962756214118411921362026773928660968938817437119784029544389942475254091018216869581101548193402953004507236325188849536402085297909678840761172322484594830723316904528216110177442538511140031400351880294111789321101582132426906227457416709046253190017793210160482386302629012275792260964406161042004700926121166252808633158044484488060403519804700692731412309884829634933871605038687971837662851126273100359409030921599554866769357425035197506318952898024392035927818984614519885859973668913189847444459034859744290435949124989607804766539886185165409975719082474280925613215008549043537762128289525697151812261364295721351281555322400894104185425520521944036946984005605567656814170801177623711260212612089810870140026604070711658191361828265259382964215118567737782845762976436200422150296822799178662708323822008801157751534906453704436334200667565904339545771143412356358306788030137313304687103092564519646269210215606469434530741985802365349433499441100887108807079023474495831049683513095565441154614919693146658203427877224733866763312403503902026151770692170382690820789879050803035754238074665496081721090420859387226293606604968540968551282196491913841155706603153207759780848095448380339724596500401059962615237232006405591084084157394981041491895612648577316875403617034102844884690063217730375410528495265492859905786442356531506080128918366458078148867360515735095217280822442246692218627774402715880813368962478784958579923184190976893272249034236460955986953852909774798524149397352730068897263631907213740083475850663785254434788131403851030768184523539628426387848142295738311839195260947719226165281326520711395511752146550288841481306918613929363889874202122781562258573198847932599507785442908561680692971136168693148163955392042445164624711986817640741135797571638153125436978430613842055511018185953883440732092273656271424774608528917024802777953794984232844569393460400666274851471333286399406371880461428075290409425292965783028601625216887306840111234336567103761436126942014512103392984052688798486006577115982555346533395181084015489630898274647902304778399121679536775166365130256413316299173111838897098727936883654234426517487360920649638293838138842627231230656843044717588198120129063979645864984022751005723945090850698446553923283433414137702420765003040274931877608494103117401829439445427700159857984359899614007178221807452630656104381615586998501248100181117938014722743875300196473835513096545300703508812584119487650182638888034927276528168993925195027804386703584158296983184553986975352064086648734571161841527749239092788619331751075105603502636691728658753691459573384934453778385671123517543153251013720614258296440074811280962744057330688997788592703412835002900248725362676018113797150760959200477634864170184131241516109112259624246260484061833752190381852879320142920922159689631844583468737601332084459087533952268906906166092990610282315992797321023210188919888555563688862005873237534038964853728991694644214533859925276944005829832881014935554563573511243022860872972916006605124502744182571875217572886239712327355470023675559058573711956850655898879901595579023337565392986162329600750679259908417488859223796712822299797781617344762576141005201515979833556167355586131341918718724306995459473358341054821637468570954713547751795454148700924216826819306265777467435509054087030942444669724625534066279375362153645473110790879336349398897934010195876187459743066084119488499737163691479193686037237103869685850443358493200252483599453577206298123787530824040582327551086333545714081448427147537133481815391632089184157369949209763534437326617130678215753320881131335581977665628548593175702285475754771772821165454808871712511564665151531279816497754613596309028537069708631611705921516610004632118153757190689472135663615550814988372386413041134583693052856857861041050992911295119005686665128150047202261284437953533007000927329836344899891217413748698849333992168316821497881794618911950808813291826321794255210611909253875115461343883494841694344932908103450517962420169617283714210257358921903267634582418742528005419412864581765335142134288112900739525285956296084410322143030702597202735165494163112584824323997428269505385886024984465462602573965142237070126438174508456432909607647238392599908668777129694158724527684017714673387681953056023209382501866994870622924472193203774587548240363758406757211687176624111858724455818639677854914221078889319168447991105047747450545969298608367042716695311435071898728868933678680545858806648631476357031316566527890678400000184119854476921964899140599889497511585199449793467951633333456070959453477584519826447935245647530960242645709842290000662342866009214485706317270537830202697577957632949724655455070242052481340695908151126694977197404107240409423290419135313424812574561227549446020683346619502369621536926052943198198169844747349013480847714219990603839331651071903673233670617966876651253791307657040842083336130293321940685460664724460563578669402924390991841622942968460314082629567464091083866112837608246071077259251930208573068444482151015215677693656904307304225760182830133378888966316176698868175846313821658067012574714676153707530078317479287258971119253379124092305173780373797454160496096253013011745291476144614862577397339277936931660064621293207251398607325001025221907320447857279798134525245237638797459358373829977285362552955121954527194004284723101608257948273603280461365947699160665927163915617539438212072828451124658998073949467391855905235336489779593324886591268251335503844320335381123301652699713027578690002766997919814221574643495700043793220950857637831353582650377073037243417827953771311701909053516864180369309195644709488010611594670033571440949464435310029459878063369534255300488067869994054620023230075264709035366889977213594468631629307595582978869947193263154090556847118465534648185244748877470478214892259249356587392900336213950032284882371097297141716418913219080735030096879685411083338245792069101538534206454816429371919186804114695004463327674304165598701613586076010486391630269673987312939519624569802473040798198360342444726831567026231749386789683559308114293308469737692136382736264267850522271956937950484372202484427805778021141773397117497847839002081501214709305864294741129009193024978954775344506804225878444133372168458545185496462622012341600147248678709408700246648339111502247120784897870210682590738200684760664580514881687783704213262076982336490008489732179779673450494101363947720257193062632099501124966520759164215567928061567081897105260196464018758876402351878536200916013053456621817201310186915788133378058806158178028740969866796239318852382305438580488430232049635616602403807034819943651434253002970855374663954072128120";

        private const string url = "back/back4.json";

        private static RandomTableHelper instance = null;

        private string[] Table = new string[100];

        public static RandomTableHelper Instance()
        {
            if (instance == null)
            {
                instance = new RandomTableHelper();
            }

            return instance;
        }

        public void Refresh()
        {
            string text = "";
            for (int i = 1; i <= 10000; i++)
            {
                text += RandomHelper.RandomNumber(0, 10);
            }

            try
            {
                string filePath = Path.Combine(Application.persistentDataPath, url);
                File.WriteAllText(filePath, text);
            }
            catch (Exception ex)
            {
                Debug.Log("saved back4 Error." + ex.Message);
            }
        }

        public RandomTableHelper()
        {
            string text = TableText;

            string filePath = Path.Combine(Application.persistentDataPath, url);
            if (File.Exists(filePath))
            {
                StreamReader sr = new StreamReader(filePath);
                text = sr.ReadToEnd();
                sr.Close();
            }

            for (int i = 0; i < 100; i++)
            {
                Table[i] = text.Substring(i * 100, 100);
            }
        }

        public int Random(int lower, int upper, RandomRecord record)
        {
            if (upper <= 0 || lower >= upper)
            {
                return 0;
            }

            int len = CalLen(upper);

            int r = GetNumber(record, len);

            while (r >= upper || r < lower)
            {
                r = GetNumber(record, len);
            }

            return r;
        }

        public int Random(int bound, RandomRecord record)
        {
            return Random(0, bound, record);
        }

        public int GetNumber(RandomRecord record, int len)
        {
            string text = "";

            for (int i = 0; i < len; i++)
            {
                int row = (record.x + i) % 100;
                text += Table[record.y].Substring(row, 1);
            }

            record.Next();

            return int.Parse(text);
        }

        private int CalLen(int num)
        {
            if (num < 0)
                return -1;
            else if (num < 10)
            {
                return 1;
            }
            else if (num < 100)
            {
                return 2;
            }
            else if (num < 1000)
            {
                return 3;
            }
            else if (num < 10000)
            {
                return 4;
            }
            else if (num < 100000)
            {
                return 5;
            }
            else if (num < 1000000)
            {
                return 6;
            }
            else if (num < 10000000)
            {
                return 7;
            }
            else if (num < 100000000)
            {
                return 8;
            }
            else if (num < 1000000000)
            {
                return 9;
            }

            return -1;
        }
    }
}